---
SETUP ON MACHINE:

- yum install ipsilon-client vim

vim /usr/lib/python2.7/site-packages/openstack_auth/views.py
line 63 prepend /dashboard/

remove everything from /usr/share/nova/nova-dist.conf in keystone_authtoken
systemctl restart openstack-nova-api

- cp /etc/httpd/conf.modules.d/10-auth_mellon.conf /etc/httpd/conf.d/auth_mellon.load

- vim /etc/keystone/keystone.conf

[auth]
saml2 = keystone.auth.plugins.mapped.Mapped

[federation]
remote_id_attribute = MELLON_IDP

- vim /var/www/cgi-bin/keystone/test

import pprint
import webob
import webob.dec


@webob.dec.wsgify
def application(req):
    return webob.Response(pprint.pformat(req.environ),
                          content_type='application/json')


- vim /etc/httpd/conf.d/10-keystone_wsgi_main.conf

#  WSGIScriptAlias "/v3/auth/OS-FEDERATION/websso/saml2" "/var/www/cgi-bin/keystone/test"

defaults in /etc/openstack-dashboard/local_settings:

# Enables keystone web single-sign-on if set to True.
#WEBSSO_ENABLED = False

# Determines which authentication choice to show as default.
#WEBSSO_INITIAL_CHOICE = "credentials"

# The list of authentication mechanisms
# which include keystone federation protocols.
# Current supported protocol IDs are 'saml2' and 'oidc'
# which represent SAML 2.0, OpenID Connect respectively.
# Do not remove the mandatory credentials mechanism.
#WEBSSO_CHOICES = (
#    ("credentials", _("Keystone Credentials")),
#    ("oidc", _("OpenID Connect")),
#    ("saml2", _("Security Assertion Markup Language")))

LOCAL:

- workon osc
- openstack role create member
- openstack project create
- openstack group create ipsilon-engineering
- openstack role add --group admin --project admin admin

- openstack identity provider create ipsilon
- openstack federation protocol create --identity-provider ipsilon --mapping ipsilon-mapping saml2

- openstack mapping create --rules mapping.json ipsilon-mapping

- openstack identity provider set --remote-id https://ipa.fedtest.org/idp/saml2/metadata ipsilon

ON MACHINE:

- export SSO_BASE=/v3/auth/OS-FEDERATION/websso/saml2
- ipsilon-client-install --saml-base $SSO_BASE --saml-sp $SSO_BASE --saml-idp-url https://ipa.fedtest.org/idp --saml-sp-logout $SSO_BASE/logout --saml-sp-post $SSO_BASE/postResponse --saml-sp-name openstack --saml-auth $SSO_BASE --port 5000
- mv /etc/httpd/conf.d/ipsilon-saml.conf /etc/httpd/conf/ipsilon-saml.conf
- vim /etc/httpd/conf/ipsilon-saml.conf

  remove everything outside the <Location> tags
  MellonMergeEnvVars On

- vim 10-keystone_wsgi_main.conf

  Include "/etc/httpd/conf/ipsilon-saml.conf"

- systemctl restart httpd

- vim /etc/keystone/keystone.conf

[auth]
add saml2 to methods

[federation]
trusted_dashboard = https://openstack.fedtest.org/dashboard/auth/websso/

- vim /etc/horizon/local_settings

WEBSSO_ENABLED = True
WEBSSO_CHOICES = (
  ("credentials", _("Keystone Credentials")),
  ("saml2", _("Ipsilon"))
)

WEBSSO_INITIAL_CHOICE = "saml2"

- Go to https://ipa.fedtest.org and add a user
- logout !!!
- need to kinit as the user or some way to change password


HELPERS:

dbus-send --print-reply --system --dest=org.freedesktop.sssd.infopipe /org/freedesktop/sssd/infopipe org.freedesktop.sssd.infopipe.GetUserGroups string:jamie

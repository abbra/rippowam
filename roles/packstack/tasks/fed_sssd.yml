---

# Bug https://bugzilla.redhat.com/show_bug.cgi?id=1249267

- name: fetch updated OSC
  yum: name={{item}} state=installed
  with_items:
    - https://admiyo.fedorapeople.org/openstack/python-openstackclient/python-openstackclient-1.0.3-3.el7.noarch.rpm
    - https://admiyo.fedorapeople.org/openstack/python-django-openstack-auth/python-django-openstack-auth-1.2.0-4.el7.noarch.rpm

- name: copy rules file
  copy:
    src=roles/packstack/files/mapping_sssd.json
    dest=/mapping_sssd.json

- name: list groups
  command:  openstack group list -c Name -f csv
  environment: os_env
  register: os_groups
  changed_when: false

- name: group
  command: openstack group create admins
  environment: os_env
  when: '"\"admins\"" not in os_groups.stdout_lines'

- name: ipausers group
  command: openstack group create ipausers
  environment: os_env
  when: '"\"ipausers\"" not in os_groups.stdout_lines'

- name: role on demo project
  command: openstack role add  --project demo --group ipausers _member_
  environment: os_env

- name: list idps
  command: openstack identity provider list -c ID -f csv
  environment: os_env
  register: os_idps
  changed_when: false

- name: identity provider
  command: openstack identity provider create --remote-id SSSD   sssd
  environment: os_env
  when: '"\"sssd\"" not in os_idps.stdout_lines'

- name: list mappings
  command: openstack mapping list -c ID -f csv
  environment: os_env
  register: os_mappings
  changed_when: false

- name: create mapping
  command: openstack mapping create --rules /mapping_sssd.json kerberos_mapping
  environment: os_env
  when: ' "\"kerberos_mapping\"" not in os_mappings.stdout_lines'

- name: list protocols
  command: openstack federation protocol list  --identity-provider  sssd -c id
    -f csv
  environment: os_env
  register: os_sssd_protocols
  changed_when: false

- name: federation protocol create
  command: openstack federation protocol create --identity-provider sssd
    --mapping kerberos_mapping kerberos
  environment: os_env
  when: ' "\"kerberos\"" not in os_sssd_protocols.stdout_lines'

- name:  Apache modules for SSSD
  yum: name=mod_auth_gssapi,mod_lookup_identity
       state=present

- name: keystone SSL
  lineinfile: dest=/etc/httpd/conf.d/{{ item[0] }}
              line="  {{ item[1] }}"
              insertbefore="</VirtualHost>"
  with_nested:
    - [ 10-keystone_wsgi_main.conf,
        10-keystone_wsgi_admin.conf ]
    - [ "LoadModule auth_gssapi_module modules/mod_auth_gssapi.so",
        "LoadModule lookup_identity_module modules/mod_lookup_identity.so",
        "SetEnv IDP_ID SSSD",
        "<location ~ \"kerberos\">",
        "AuthType GSSAPI",
        "AuthName GSSAPI-SSO",
        "GssapiCredStore keytab:/etc/httpd/conf/openstack.keytab",
        "GssapiLocalName on",
        "GssapiSSLonly On",
        "Require valid-user",
        "LookupUserAttr mail REMOTE_USER_EMAIL ",
        "LookupUserGroups REMOTE_USER_GROUPS \";\"",
        "</location>" ]
  notify: restart httpd


- name: Kerberos as Login mechanism
  ini_file: dest=/etc/keystone/keystone.conf
            section=auth
            option={{ item.key }}
            value={{ item.value }}
  with_dict:
    methods: external,password,token,oauth1,kerberos
    kerberos: keystone.auth.plugins.mapped.Mapped
  notify: restart httpd

- name: Kerberos as Login mechanism
  ini_file: dest=/etc/keystone/keystone.conf
            section=federation
            option={{ item.key }}
            value={{ item.value }}
  with_dict:
    trusted_dashboard: https://{{ ansible_fqdn }}/dashboard/auth/websso/
    sso_callback_template: /etc/keystone/sso_callback_template.html
  notify: restart httpd


- name: Kerberos as Login mechanism
  ini_file: dest=/etc/keystone/keystone.conf
            section=kerberos
            option=remote_id_attribute
            value=IDP_ID
  notify: restart httpd


- name: horizon WebSSO Configuration
  lineinfile: dest=/etc/openstack-dashboard/local_settings
              line="{{ item }}"
  with_items:
    - "WEBSSO_ENABLED = True "
    - "WEBSSO_CHOICES = (('credentials', _('Keystone Credentials')),('kerberos', _('Kerberos')),)"
    - "WEBSSO_INITIAL_CHOICE='kerberos'"
    - "OPENSTACK_KEYSTONE_DEFAULT_ROLE='Member'"
    - "OPENSTACK_HOST='{{ ansible_fqdn }}'"
  notify:
    - restart httpd
